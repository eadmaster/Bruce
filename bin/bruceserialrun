#!/bin/bash

# args checking
if [ -z "$1" ] || [ ! -f "$1" ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
	echo "usage: $(basename $0) INPUT_FILE"
	echo
	exit 0
fi


INPUTFILE="$1"
INPUTFILEEXT=$( echo -n "$INPUTFILE" | rev | cut -d'.' -f1 | rev )
INPUTFILEEXT=$( echo -n $INPUTFILEEXT | tr '[A-Z]' '[a-z]' ) # force lowercase extension

# check file size
INPUTFILESIZE=$(stat -c '%s' "$INPUTFILE")
if [ $INPUTFILESIZE -gt 4000 ]; then
	echo "input file is too big (max 4kb)"
	exit 1
fi

SERIAL_CMD=""

# try to detect the input file type according on its extension (useful if file is missing or buggy)
case $INPUTFILEEXT in
	sub ) SERIAL_CMD="subghz tx_from_buffer" ;;
	ir ) SERIAL_CMD="ir tx_from_buffer" ;;
	txt ) SERIAL_CMD="badusb run_from_buffer" ;;
	js|bjs ) SERIAL_CMD="js run_from_buffer" ;;
esac

if [ -z "$SERIAL_CMD" ]; then
    echo "$(basename $0) err: unsupported file format: $INPUTFILEEXT"
    exit 1
fi

echo "$SERIAL_CMD" | busybox microcom -s 115200 /dev/ttyACM0 -t 1000

sleep 1

cat "$INPUTFILE" | busybox microcom -s 115200 /dev/ttyACM0 -t 1000

echo "EOF" | busybox microcom -s 115200 /dev/ttyACM0
#echo -e '\x04' | busybox microcom -s 115200 /dev/ttyACM0
